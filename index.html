<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  <title>YJ K-Stock Quant Unified Dashboard</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2e; --panel2:#0c1628; --line:rgba(148,163,184,.18);
      --txt:#e5e7eb; --muted:#94a3b8; --good:#34d399; --bad:#fb7185; --warn:#fbbf24;
      --accent:#60a5fa; --radius:16px;
      --vh: 1vh;
      --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left); --sar: env(safe-area-inset-right);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{ 
      margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
      background: var(--bg); color:var(--txt); overflow:hidden; 
      height: 100vh; height: calc(var(--vh, 1vh) * 100); touch-action: manipulation;
      padding-top: var(--sat); padding-bottom: var(--sab); padding-left: var(--sal); padding-right: var(--sar);
    }
    .app{ display:flex; flex-direction:column; height:100%; }
    .header-section { flex-shrink: 0; z-index: 100; background: var(--bg); }
    .tabbar { margin: 15px 20px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; overflow-x: auto; scrollbar-width: none; -webkit-overflow-scrolling: touch; padding-right: 20px; }
    .tabbar::-webkit-scrollbar { display: none; }
    .tab-btn { padding: 10px 18px; border-radius: 10px; border: 1px solid var(--line); background: var(--panel); color: #fff; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; white-space: nowrap; flex-shrink: 0; }
    .tab-btn.on { background: linear-gradient(135deg, #3b82f6, #2563eb); border-color: #60a5fa; box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
    #perfFilterGroup { display: none; align-items: center; gap: 6px; margin-left: 5px; padding-left: 15px; border-left: 1px solid var(--line); animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
    .filter-btn { background: var(--panel2); border: 1px solid var(--line); color: var(--muted); padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; white-space: nowrap; flex-shrink: 0; }
    .filter-btn.active { background: var(--txt); color: var(--bg) !important; border-color: var(--txt) !important; box-shadow: 0 0 8px rgba(255,255,255,0.2); }
    .filter-btn[data-filter="TREND"] { color: #34d399; border-color: rgba(52, 211, 153, 0.2); }
    .filter-btn[data-filter="PULLBACK"] { color: #fbbf24; border-color: rgba(251, 191, 36, 0.2); }
    .filter-btn[data-filter="BREAKOUT"] { color: #fb7185; border-color: rgba(251, 113, 133, 0.2); }
    .filter-btn[data-filter="SELL"] { color: #c084fc; border-color: rgba(192, 132, 252, 0.2); }
    .main{ flex:1; display:flex; overflow:hidden; padding: 0 20px 20px 20px; gap:20px; }
    @media (max-width: 1024px) { .main { flex-direction: column; overflow-y: auto; padding: 0 12px 12px 12px; gap: 12px; } .content-area, #detailPanel { flex: none !important; width: 100% !important; height: auto !important; } #detailPanel { min-height: 520px; margin-bottom: 20px; } .table-container { max-height: 50vh; } }
    .content-area { flex: 1.3; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
    #detailPanel { flex: 0.7; background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius); display: none; flex-direction: column; overflow: hidden; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .custom-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    .table-container { flex: 1; background: var(--panel2); border-radius: var(--radius); border: 1px solid var(--line); position: relative; display: flex; flex-direction: column; overflow: hidden; }
    .table-responsive { flex: 1; overflow: auto; -webkit-overflow-scrolling: touch; }
    table { width:100%; border-collapse:collapse; font-size:12px; min-width:820px; table-layout: fixed; }
    tr.clickable:hover { background: rgba(255,255,255,0.05); cursor: pointer; }
    th { background: #162136; color: var(--muted); padding: 12px 6px; text-align:left; position: sticky; top: 0; z-index: 20; border-bottom: 2px solid var(--accent); white-space: nowrap; }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { color: #fff; background: #1e2d4a; }
    th.sortable::after { content: " â†•"; font-size: 10px; opacity: 0.3; }
    th.sort-desc::after { content: " â†“"; opacity: 1; color: var(--accent); }
    th.sort-asc::after { content: " â†‘"; opacity: 1; color: var(--accent); }
    td { padding: 10px 6px; border-bottom: 1px solid var(--line); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .numRight { text-align:right; font-family: 'Roboto Mono', monospace; }
    .col-code { width: 60px; } .col-name { width: 110px; } .col-price { width: 85px; } .col-rsi { width: 60px; } .col-stoch { width: 65px; } .col-turn { width: 85px; } .col-sig { width: 140px; } .col-date { width: 85px; } .col-perf { width: 70px; } .col-sell { width: 65px; }
    .col-type { width: 70px; text-align: center; } .col-target { width: 80px; text-align: right; color: var(--good); } .col-stop { width: 80px; text-align: right; color: var(--bad); }
    .top-stats-container { display: flex; justify-content: flex-start; margin-bottom: 15px; flex-shrink: 0; width: 100%; }
    .mini-card { background: var(--panel2); border: 1px solid var(--line); border-radius: 12px; padding: 10px; width: 100%; max-width: 520px; flex-shrink: 0; display: block; overflow-x: auto; }
    .mini-card h4 { margin: 0 0 8px 0; font-size: 12px; font-weight: 800; color: var(--bad); border-bottom: 1px solid var(--line); padding-bottom: 5px; }
    .mini-table { width: 100%; min-width: 280px; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
    .mini-table th { background: none; padding: 4px 3px; color: var(--muted); border-bottom: 1px solid var(--line); font-weight: 800; text-align: left; white-space: nowrap; }
    .mini-table td { padding: 6px 3px; border-bottom: 1px solid rgba(255,255,255,0.03); overflow: hidden; text-overflow: ellipsis; }
    .best-date { width: 18% !important; color: var(--muted); font-family: 'Roboto Mono', monospace; }
    .best-name { width: 35% !important; white-space: normal !important; overflow: visible !important; text-overflow: clip !important; line-height: 1.2; }
    .best-sig { width: 27% !important; text-align: center; } .best-perf { width: 20% !important; text-align: right; }
    .badge-sig { display: inline-flex; align-items: center; padding: 1px 3px; border-radius: 8px; font-size: 9px; font-weight: 800; margin-right: 1px; }
    .badge-sig::before { content: ""; width: 3px; height: 3px; border-radius: 50%; display: inline-block; margin-right: 2px; }
    .sig-trend { background: rgba(16, 185, 129, 0.15); color: #34d399; } .sig-trend::before { background: #34d399; }
    .sig-pullback { background: rgba(245, 158, 11, 0.15); color: #fbbf24; } .sig-pullback::before { background: #fbbf24; }
    .sig-breakout { background: rgba(239, 68, 68, 0.15); color: #fb7185; } .sig-breakout::before { background: #fb7185; }
    .type-profit { background: rgba(239, 68, 68, 0.2); color: #fca5a5; } .type-profit::before { background: #fca5a5; }
    .type-winrate { background: rgba(245, 158, 11, 0.2); color: #fcd34d; } .type-winrate::before { background: #fcd34d; }
    .type-hidden { background: rgba(59, 130, 246, 0.2); color: #93c5fd; } .type-hidden::before { background: #93c5fd; }
    .sig-sell { background: rgba(148, 163, 184, 0.15); color: #94a3b8; } .sig-sell::before { background: #94a3b8; }
    .sig-alert { background: rgba(244, 63, 94, 0.2); color: #fb7185; border: 1px solid rgba(244, 63, 94, 0.3); animation: pulse 2s infinite; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 20px; background: rgba(255,255,255,0.02); }
    .info-item { display: flex; flex-direction: column; gap: 4px; }
    .info-label { font-size: 11px; color: var(--muted); }
    .info-value { font-size: 16px; font-weight: 700; color: #fff; }
    .card { border:1px solid var(--line); background: var(--panel); border-radius: var(--radius); padding: 10px; cursor: pointer; transition: 0.2s; }
    .card:hover { border-color: var(--accent); transform: translateY(-1px); }
    /* Insight Grid */
    .insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; height: 100%; overflow-y: auto; padding-bottom: 20px; }
    .insight-card { background: var(--panel2); border: 1px solid var(--line); border-radius: var(--radius); padding: 20px; display: flex; flex-direction: column; }
    .chart-box { flex: 1; min-height: 250px; position: relative; }
    @media (max-width: 768px) { .insight-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div class="app">
  <div class="header-section">
    <div style="padding: 12px 20px; border-bottom: 1px solid var(--line); display:flex; justify-content:space-between; align-items:center; background: rgba(15,26,46,0.95);">
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="width:32px; height:32px; background:linear-gradient(135deg, #3b82f6, #10b981); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px;">Q</div>
        <div>
          <div style="font-size: 16px; font-weight:800; color:#fff;">YJ K-STOCK QUANT</div>
          <div id="statusLine" style="font-size: 10px; color: var(--muted);">ë°ì´í„° ë™ê¸°í™” ëŒ€ê¸° ì¤‘...</div>
        </div>
      </div>
      <button style="padding: 8px 16px; border-radius: 8px; background: rgba(52, 211, 153, 0.1); border:1px solid rgba(52, 211, 153, 0.3); color:#34d399; font-weight:bold; cursor:pointer; font-size:12px;" id="btnRefresh">ğŸ”„ ë°ì´í„° ê°±ì‹ </button>
    </div>

    <div class="tabbar">
      <button class="tab-btn on" onclick="setTab('screen')" id="tab-screen">ğŸ” ì‹¤ì‹œê°„ í¬ì°©</button>
      <button class="tab-btn" onclick="setTab('daily')" id="tab-daily">ğŸ“… Dailypick</button>
      <button class="tab-btn" onclick="setTab('perf')" id="tab-perf">ğŸ“Š ì„±ê³¼ ì¶”ì </button>
      <button class="tab-btn" onclick="setTab('insight')" id="tab-insight" style="background:rgba(96,165,250,0.1)">ğŸ§  AI Insight</button>
      
      <div id="perfFilterGroup">
        <button class="filter-btn active" onclick="setPerfFilter('ALL', this)" data-filter="ALL">ì „ì²´</button>
        <button class="filter-btn" onclick="setPerfFilter('TREND', this)" data-filter="TREND">ì¶”ì„¸</button>
        <button class="filter-btn" onclick="setPerfFilter('PULLBACK', this)" data-filter="PULLBACK">ëˆŒë¦¼</button>
        <button class="filter-btn" onclick="setPerfFilter('BREAKOUT', this)" data-filter="BREAKOUT">ëŒíŒŒ</button>
        <button class="filter-btn" onclick="setPerfFilter('SELL', this)" data-filter="SELL">ë§¤ë„í¬ì°©</button>
      </div>
    </div>
  </div>
  
  <div class="main">
    <div class="content-area">
      <section id="view-screen" style="display: flex; flex-direction: column; height: 100%;">
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-bottom:15px; flex-shrink: 0;">
          <div class="card" onclick="switchList('ALL')">
            <div style="font-size:10px; color:var(--muted); margin-bottom:4px;">ì „ì²´</div>
            <div style="font-size:20px; font-weight:800;" id="statAll">-</div>
          </div>
          <div class="card" onclick="switchList('TREND')">
            <div style="font-size:10px; color:#34d399; margin-bottom:4px;">ì¶”ì„¸</div>
            <div style="font-size:20px; font-weight:800; color:#34d399;" id="statTrend">-</div>
          </div>
          <div class="card" onclick="switchList('PULLBACK')">
            <div style="font-size:10px; color:#fbbf24; margin-bottom:4px;">ëˆŒë¦¼</div>
            <div style="font-size:20px; font-weight:800; color:#fbbf24;" id="statPullback">-</div>
          </div>
          <div class="card" onclick="switchList('BREAKOUT')">
            <div style="font-size:10px; color:#fb7185; margin-bottom:4px;">ëŒíŒŒ</div>
            <div style="font-size:20px; font-weight:800; color:#fb7185;" id="statBreakout">-</div>
          </div>
        </div>

        <div class="table-container">
          <div style="padding: 12px 15px; border-bottom: 1px solid var(--line); display:flex; justify-content:space-between; align-items:center; background: rgba(255,255,255,0.02); z-index: 30;">
            <span id="listTitle" style="font-weight:700; font-size:14px; color:var(--accent);">ë¦¬ìŠ¤íŠ¸: ì „ì²´ë³´ê¸°</span>
          </div>
          <div class="table-responsive custom-scroll">
            <table id="mainTable">
              <thead>
                <tr>
                  <th class="col-code">ì½”ë“œ</th>
                  <th class="col-name">ì¢…ëª©ëª…</th>
                  <th class="col-price numRight">í˜„ì¬ê°€</th>
                  <th class="col-rsi numRight">RSI</th>
                  <th class="col-stoch numRight">Stoch K</th>
                  <th class="col-turn numRight">ê±°ë˜ëŒ€ê¸ˆ</th>
                  <th class="col-sig" style="text-align:center;">ì‹œê·¸ë„</th>
                </tr>
              </thead>
              <tbody id="screenTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="view-daily" style="display:none; flex-direction: column; height: 100%;">
        <div class="table-container">
            <div style="padding: 10px; border-bottom: 1px solid var(--line); font-weight:700; background: var(--panel2); display:flex; justify-content:space-between; align-items: center;">
              <span style="font-size:13px;">ğŸ“… Daily Pick ë¡œê·¸</span>
            </div>
            <div class="table-responsive custom-scroll">
              <table style="min-width: 1200px;"> 
                <thead>
                  <tr>
                    <th class="col-date">Pickì¼ì</th>
                    <th class="col-type">Type</th>
                    <th class="col-code">ì½”ë“œ</th>
                    <th class="col-name">ì¢…ëª©ëª…</th>
                    <th class="col-price numRight">ì§„ì…ê°€</th>
                    <th class="col-target numRight">ëª©í‘œ1</th>
                    <th class="col-target numRight">ëª©í‘œ2</th>
                    <th class="col-stop numRight">ì†ì ˆ1</th>
                    <th class="col-stop numRight">ì†ì ˆ2</th>
                    <th class="col-price numRight">í˜„ì¬ê°€</th>
                    <th class="col-perf numRight">ìˆ˜ìµë¥ </th>
                    <th class="col-perf numRight">D1</th>
                    <th class="col-perf numRight">D3</th>
                    <th class="col-perf numRight">D5</th>
                    <th class="col-perf numRight">D7</th>
                    <th class="col-perf numRight">D9</th>
                  </tr>
                </thead>
                <tbody id="dailyTbody"></tbody>
              </table>
            </div>
          </div>
      </section>

      <section id="view-perf" style="display:none; flex-direction: column; height: 100%;">
        <div class="top-stats-container">
          <div class="mini-card">
            <h4 id="bestTitle">ğŸ”¥ ìˆ˜ìµë¥  Best 5 (ì „ì²´)</h4>
            <table class="mini-table">
              <thead><tr><th class="best-date">í¬ì°©ì¼</th><th class="best-name">ì¢…ëª©ëª…</th><th class="best-sig">ì‹œê·¸ë„</th><th class="best-perf">ìˆ˜ìµë¥ </th></tr></thead>
              <tbody id="bestTbody"></tbody>
            </table>
          </div>
        </div>
        <div class="table-container">
          <div class="table-responsive custom-scroll">
            <table>
              <thead>
                <tr>
                  <th class="col-date">í¬ì°©ì¼</th><th class="col-code">ì½”ë“œ</th><th class="col-name">ì¢…ëª©ëª…</th><th class="col-sig">ì‹œê·¸ë„</th><th class="col-sell">ë§¤ë„ì‹ í˜¸</th><th class="col-price numRight">í¬ì°©ê°€</th><th class="col-price numRight">í˜„ì¬ê°€</th><th class="col-perf numRight sortable" id="sort-Return">ìˆ˜ìµë¥ </th><th class="col-perf numRight sortable" id="sort-D1">D1</th><th class="col-perf numRight sortable" id="sort-D3">D3</th><th class="col-perf numRight sortable" id="sort-D5">D5</th><th class="col-perf numRight sortable" id="sort-D7">D7</th><th class="col-perf numRight sortable" id="sort-D9">D9</th>
                </tr>
              </thead>
              <tbody id="perfTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="view-insight" style="display:none; flex-direction:column; height:100%;">
        <div class="insight-grid custom-scroll">
          <div class="insight-card"><div style="margin-bottom:10px; font-weight:700;">ğŸ“Š ì „ëµë³„ ìŠ¹ë¥ </div><div class="chart-box"><canvas id="chartWinRate"></canvas></div></div>
          <div class="insight-card"><div style="margin-bottom:10px; font-weight:700;">ğŸ’° ì „ëµë³„ í‰ê·  ìˆ˜ìµ</div><div class="chart-box"><canvas id="chartAvgReturn"></canvas></div></div>
          <div class="insight-card" style="grid-column: span 2;"><div style="margin-bottom:10px; font-weight:700;">ğŸ“ˆ ê¸°ê°„ë³„ ìˆ˜ìµ ì¶”ì´</div><div class="chart-box"><canvas id="chartTimeSeries"></canvas></div></div>
        </div>
      </section>
    </div>

    <div id="detailPanel">
      <div style="padding: 15px 20px; border-bottom: 1px solid var(--line); display:flex; justify-content:space-between; align-items:center; background:var(--panel2); flex-shrink: 0;">
        <div><span id="detailCode" style="font-family:monospace; font-size:12px; color:var(--accent); display:block; margin-bottom:2px;">CODE</span><b id="detailName" style="font-size:18px;">ì¢…ëª© ì„ íƒ</b></div>
        <button onclick="closeDetail()" style="background:none; border:none; color:var(--muted); font-size:20px; cursor:pointer;">âœ•</button>
      </div>
      <div class="info-grid" id="detailStats" style="flex-shrink: 0;">
        <div class="info-item"><div class="info-label">í˜„ì¬ê°€</div><div class="info-value" id="valPrice">-</div></div>
        <div class="info-item"><div class="info-label">ê±°ë˜ëŒ€ê¸ˆ</div><div class="info-value" id="valTurnover">-</div></div>
        <div class="info-item"><div class="info-label">RSI (14)</div><div class="info-value" id="valRSI">-</div></div>
        <div class="info-item"><div class="info-label">Stochastic K</div><div class="info-value" id="valStoch">-</div></div>
        <div class="info-item" style="grid-column: span 2;"><div class="info-label">í¬ì°© ì‹œê·¸ë„</div><div id="valSignals" style="display:flex; flex-wrap:wrap; gap:4px; margin-top:5px;">-</div></div>
      </div>
      <div id="chartContainer" style="flex:1; background:#000; border-top:1px solid var(--line);"></div>
    </div>
  </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
const setVh = () => {
  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
};
window.addEventListener('resize', setVh);
setVh();

const URLS = {
  ALL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=0&single=true&output=csv",
  TREND: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=1981708246&single=true&output=csv",
  PULLBACK: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=852505203&single=true&output=csv",
  BREAKOUT: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=258627301&single=true&output=csv",
  STORAGE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=2034892211&single=true&output=csv",
  DAILY: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=1927472233&single=true&output=csv"
};

let data = { ALL:[], TREND:[], PULLBACK:[], BREAKOUT:[], STORAGE:[], DAILY:[] };
let currentMode = 'ALL';
let currentTab = 'screen';
let perfSortKey = null; 
let perfSortDir = 'original';
let perfFilter = 'ALL'; 
let charts = {};

function parseCSV(text) {
  if(!text) return [];
  const rows = [];
  const lines = text.split(/\r?\n/);
  for (let line of lines) {
    if (!line.trim()) continue;
    const row = [];
    let curVal = "", inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') {
        if (inQuotes && line[i+1] === '"') { curVal += '"'; i++; } 
        else inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) { row.push(curVal.trim()); curVal = ""; } 
      else curVal += char;
    }
    row.push(curVal.trim());
    rows.push(row);
  }
  if (!rows.length) return [];
  const header = rows.shift().map(h => h.trim());
  return rows.map(r => {
    let obj = {}; 
    header.forEach((h, i) => { obj[h] = (r[i] !== undefined) ? r[i].trim() : ""; });
    return obj;
  });
}

function fmtPrice(n) {
  if (!n) return "-";
  const num = parseFloat(String(n).replace(/[^-0-9.]/g, ""));
  return isNaN(num) ? "-" : num.toLocaleString('ko-KR');
}

function fmtTurnover(n) {
  if (!n) return "-";
  const num = parseFloat(String(n).replace(/[^-0-9.]/g, ""));
  return isNaN(num) ? "-" : Math.floor(num / 100000000).toLocaleString() + "ì–µ";
}

function getSigCount(r) {
  let count = 0;
  if(String(r.Trend).toUpperCase()==="TRUE") count++;
  if(String(r.Pullback).toUpperCase()==="TRUE") count++;
  if(String(r.Breakout).toUpperCase()==="TRUE") count++;
  return count;
}

function checkSignal(r, type) {
    if (type === 'ALL') return true;
    if (type === 'SELL') {
        const bbUpper = parseFloat(String(r.BB_Upper || 0).replace(/[^-0-9.]/g, ""));
        const current = parseFloat(String(r.Close_Today || 0).replace(/[^-0-9.]/g, ""));
        const sheetSellSignal = String(r['ë§¤ë„ì‹ í˜¸'] || "").trim().toUpperCase();
        return (sheetSellSignal === "TRUE") || (bbUpper > 0 && current > (bbUpper * 1.03));
    }
    let colVal = "";
    if (type === 'TREND') colVal = r.Trend;
    else if (type === 'PULLBACK') colVal = r.Pullback;
    else if (type === 'BREAKOUT') colVal = r.Breakout;
    
    if (String(colVal).toUpperCase() === 'TRUE') return true;
    
    const rowStr = Object.values(r).join(" ").toUpperCase();
    const map = { 'TREND': 'ì¶”ì„¸', 'PULLBACK': 'ëˆŒë¦¼', 'BREAKOUT': 'ëŒíŒŒ' };
    if (rowStr.includes(type) || rowStr.includes(map[type])) return true;
    return false;
}

function getBadges(r) {
  let h = "";
  if(String(r.Trend).toUpperCase()==="TRUE") h += '<span class="badge-sig sig-trend">ì¶”ì„¸</span>';
  if(String(r.Pullback).toUpperCase()==="TRUE") h += '<span class="badge-sig sig-pullback">ëˆŒë¦¼</span>';
  if(String(r.Breakout).toUpperCase()==="TRUE") h += '<span class="badge-sig sig-breakout">ëŒíŒŒ</span>';
  
  if (!h) {
    const rowValues = Object.values(r).join(" ").toUpperCase();
    if(rowValues.includes("TREND") || rowValues.includes("ì¶”ì„¸")) h += '<span class="badge-sig sig-trend">ì¶”ì„¸</span>';
    if(rowValues.includes("PULLBACK") || rowValues.includes("ëˆŒë¦¼")) h += '<span class="badge-sig sig-pullback">ëˆŒë¦¼</span>';
    if(rowValues.includes("BREAKOUT") || rowValues.includes("ëŒíŒŒ")) h += '<span class="badge-sig sig-breakout">ëŒíŒŒ</span>';
  }
  return h || "-";
}

function getTypeBadge(t) {
  if(!t) return "-";
  if(t.includes("ìˆ˜ìµ")) return '<span class="badge-sig type-profit">ìˆ˜ìµ</span>';
  if(t.includes("ìŠ¹ë¥ ")) return '<span class="badge-sig type-winrate">ìŠ¹ë¥ </span>';
  if(t.includes("íˆë“ ")) return '<span class="badge-sig type-hidden">íˆë“ </span>';
  return t;
}

function getPerfColor(v) {
   const x = parseFloat(String(v || "").replace('%',''));
   return isNaN(x) ? 'inherit' : (x > 0 ? 'var(--bad)' : '#fff');
}
function getPctTxt(v) {
   const x = parseFloat(String(v || "").replace('%',''));
   return isNaN(x) ? "-" : (x > 0 ? "+" : "") + x.toFixed(1) + "%";
}

function openDetail(r) {
  const panel = document.getElementById('detailPanel');
  panel.style.display = 'flex';
  document.getElementById('detailName').textContent = r.Name;
  document.getElementById('detailCode').textContent = String(r.Code).padStart(6,'0');
  document.getElementById('valPrice').textContent = fmtPrice(r.Close || r.Close_Today || r.EntryPrice);
  document.getElementById('valTurnover').textContent = fmtTurnover(r.Turnover);
  document.getElementById('valRSI').textContent = r.RSI14 ? parseFloat(r.RSI14).toFixed(1) : "-";
  document.getElementById('valStoch').textContent = r.Stoch_K ? parseFloat(r.Stoch_K).toFixed(1) : "-";
  document.getElementById('valSignals').innerHTML = getBadges(r);
  
  if(window.innerWidth <= 1024) panel.scrollIntoView({behavior:'smooth'});

  document.getElementById('chartContainer').innerHTML = ""; 
  new TradingView.widget({
    "autosize": true, "symbol": "KRX:" + String(r.Code).padStart(6, '0'),
    "interval": "D", "timezone": "Asia/Seoul", "theme": "dark", "style": "1", "locale": "ko",
    "container_id": "chartContainer", "hide_top_toolbar": true
  });
}

function closeDetail() { document.getElementById('detailPanel').style.display = 'none'; }

async function load() {
  document.getElementById('statusLine').textContent = "Loading...";
  const ts = Date.now();
  for(const key of Object.keys(URLS)) {
    try {
      const res = await fetch(URLS[key] + "&ts=" + ts);
      data[key] = parseCSV(await res.text());
    } catch(e) { console.error(e); }
  }
  render();
  document.getElementById('statusLine').textContent = "Updated: " + new Date().toLocaleTimeString();
}

function handlePerfSort(key) {
  if (perfSortKey === key) {
    if (perfSortDir === 'original') perfSortDir = 'desc';
    else if (perfSortDir === 'desc') perfSortDir = 'asc';
    else perfSortDir = 'original';
  } else {
    perfSortKey = key;
    perfSortDir = 'desc';
  }
  render();
}

function setPerfFilter(filterType, btn) {
  perfFilter = filterType;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  render();
}

function render() {
  if(data.ALL) {
    document.getElementById('statAll').textContent = data.ALL.length;
    document.getElementById('statTrend').textContent = data.TREND ? data.TREND.length : "-";
    document.getElementById('statPullback').textContent = data.PULLBACK ? data.PULLBACK.length : "-";
    document.getElementById('statBreakout').textContent = data.BREAKOUT ? data.BREAKOUT.length : "-";
  }

  // 1. Screen View Logic (Matches the working GitHub code)
  let list = data[currentMode] || [];
  
  // Fallback: If specific sheet data is missing, filter from ALL
  if(list.length === 0 && data.ALL && currentMode !== 'ALL') {
     list = data.ALL.filter(r => checkSignal(r, currentMode));
  }

  const sortedList = [...list].sort((a, b) => {
    const cB = getSigCount(b), cA = getSigCount(a);
    if (cB !== cA) return cB - cA;
    return (parseFloat(String(b.Turnover).replace(/,/g,''))||0) - (parseFloat(String(a.Turnover).replace(/,/g,''))||0);
  });

  document.getElementById('screenTbody').innerHTML = sortedList.map(r => `
    <tr class="clickable" onclick='openDetail(${JSON.stringify(r)})'>
      <td class="col-code" style="color:var(--muted); font-family:monospace;">${String(r.Code).padStart(6,'0')}</td>
      <td class="col-name" style="font-weight:700; color:#fff;">${r.Name}</td>
      <td class="col-price numRight">${fmtPrice(r.Close)}</td>
      <td class="col-rsi numRight" style="color:${parseFloat(r.RSI14||0)>=70?'var(--bad)':'inherit'}">${parseFloat(r.RSI14||0).toFixed(1)}</td>
      <td class="numRight col-stoch" style="color:${parseFloat(r.Stoch_K||0)>=80?'var(--bad)':'inherit'}">${parseFloat(r.Stoch_K||0).toFixed(1)}</td>
      <td class="numRight col-turn" style="color:var(--muted)">${fmtTurnover(r.Turnover)}</td>
      <td class="col-sig" style="text-align:center;">${getBadges(r)}</td>
    </tr>
  `).join('');

  // 2. Perf View
  const rawStorage = (data.STORAGE || []);
  let storageList = [...rawStorage].reverse(); 
  if (perfFilter !== 'ALL') storageList = storageList.filter(r => checkSignal(r, perfFilter));

  // Best 5
  const calcList = [...storageList].map(item => ({
    ...item, valReturn: parseFloat(String(item.Return || "").replace('%','')) || -999
  })).sort((a, b) => b.valReturn - a.valReturn);

  document.getElementById('bestTbody').innerHTML = calcList.slice(0, 5).map(r => `
    <tr class="clickable" onclick='openDetail(${JSON.stringify(r)})'>
      <td class="best-date">${(r.DetectDate || "").split(' ')[0].substring(5)}</td>
      <td class="best-name">${r.Name}</td> 
      <td class="best-sig">${getBadges(r)}</td>
      <td class="best-perf" style="color:var(--bad); font-weight:800;">${getPctTxt(r.Return)}</td>
    </tr>
  `).join('');

  // Sort Logic for Perf Table
  if (perfSortKey && perfSortDir !== 'original') {
    storageList.sort((a, b) => {
      const vA = parseFloat(String(a[perfSortKey] || "").replace('%','')) || -999;
      const vB = parseFloat(String(b[perfSortKey] || "").replace('%','')) || -999;
      return perfSortDir === 'desc' ? vB - vA : vA - vB;
    });
  }
  
  document.querySelectorAll('th.sortable').forEach(th => {
    const key = th.id.replace('sort-', '');
    th.classList.remove('sort-desc', 'sort-asc');
    if (key === perfSortKey && perfSortDir !== 'original') th.classList.add('sort-' + perfSortDir);
  });

  document.getElementById('perfTbody').innerHTML = storageList.map(r => `
    <tr class="clickable" onclick='openDetail(${JSON.stringify(r)})'>
      <td class="col-date" style="color:var(--muted)">${(r.DetectDate || "").split(' ')[0]}</td>
      <td class="col-code">${String(r.Code).padStart(6,'0')}</td>
      <td class="col-name" style="font-weight:700;">${r.Name}</td>
      <td class="col-sig" style="text-align:center;">${getBadges(r)}</td>
      <td class="col-sell" style="text-align:center;">${checkSignal(r,'SELL')?'<span class="badge-sig sig-alert">ë§¤ë„í¬ì°©</span>':'-'}</td>
      <td class="col-price numRight" style="color:var(--muted)">${fmtPrice(r.EntryPrice)}</td>
      <td class="col-price numRight">${fmtPrice(r.Close_Today)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.Return)}; font-weight:700;">${getPctTxt(r.Return)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.D1)}">${getPctTxt(r.D1)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.D3)}">${getPctTxt(r.D3)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.D5)}">${getPctTxt(r.D5)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.D7)}">${getPctTxt(r.D7)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.D9)}">${getPctTxt(r.D9)}</td>
    </tr>
  `).join('');

  // 3. Daily View
  const dailyList = (data.DAILY || []).slice().reverse(); 
  document.getElementById('dailyTbody').innerHTML = dailyList.map(r => `
    <tr class="clickable" onclick='openDetail(${JSON.stringify(r)})'>
      <td class="col-date" style="color:var(--muted)">${(r.PickDate || "").split(' ')[0]}</td>
      <td class="col-type">${getTypeBadge(r.Type)}</td>
      <td class="col-code">${String(r.Code).padStart(6,'0')}</td>
      <td class="col-name" style="font-weight:700;">${r.Name}</td>
      <td class="col-price numRight">${fmtPrice(r.EntryPrice)}</td>
      <td class="col-target numRight">${fmtPrice(r.TargetPrice1)}</td>
      <td class="col-target numRight">${fmtPrice(r.TargetPrice2)}</td>
      <td class="col-stop numRight">${fmtPrice(r.StopPrice1)}</td>
      <td class="col-stop numRight">${fmtPrice(r.StopPrice2)}</td>
      <td class="col-price numRight">${fmtPrice(r.Close_Today)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.Return)}; font-weight:700;">${getPctTxt(r.Return)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.D1)}">${getPctTxt(r.D1)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.D3)}">${getPctTxt(r.D3)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.D5)}">${getPctTxt(r.D5)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.D7)}">${getPctTxt(r.D7)}</td>
      <td class="col-perf numRight" style="color:${getPerfColor(r.D9)}">${getPctTxt(r.D9)}</td>
    </tr>
  `).join('');
}

// Insight Chart Logic
function renderCharts() {
  const d = data.STORAGE || [];
  if(!d.length) return;
  const stats = { 'Trend':{w:0,t:0,sum:0}, 'Pullback':{w:0,t:0,sum:0}, 'Breakout':{w:0,t:0,sum:0} };
  d.forEach(r => {
    let ret = parseFloat(String(r.Return).replace('%',''));
    if(isNaN(ret)) return;
    if(checkSignal(r, 'TREND')) { stats.Trend.t++; stats.Trend.sum+=ret; if(ret>0) stats.Trend.w++; }
    if(checkSignal(r, 'PULLBACK')) { stats.Pullback.t++; stats.Pullback.sum+=ret; if(ret>0) stats.Pullback.w++; }
    if(checkSignal(r, 'BREAKOUT')) { stats.Breakout.t++; stats.Breakout.sum+=ret; if(ret>0) stats.Breakout.w++; }
  });
  const labels = ['Trend', 'Pullback', 'Breakout'];
  const winRates = labels.map(k => stats[k].t ? (stats[k].w/stats[k].t*100) : 0);
  const avgRets = labels.map(k => stats[k].t ? (stats[k].sum/stats[k].t) : 0);

  if(charts.win) charts.win.destroy();
  charts.win = new Chart(document.getElementById('chartWinRate'), { type: 'bar', data: { labels:['ì¶”ì„¸','ëˆŒë¦¼','ëŒíŒŒ'], datasets:[{label:'ìŠ¹ë¥ ', data:winRates, backgroundColor:['#34d399','#fbbf24','#fb7185']}] }, options:{indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{max:100, grid:{color:'#1e293b'}}, y:{grid:{display:false}}}} });

  if(charts.ret) charts.ret.destroy();
  charts.ret = new Chart(document.getElementById('chartAvgReturn'), { type: 'bar', data: { labels:['ì¶”ì„¸','ëˆŒë¦¼','ëŒíŒŒ'], datasets:[{label:'í‰ê· ìˆ˜ìµ', data:avgRets, backgroundColor:'#3b82f6'}] }, options:{plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'#1e293b'}}}} });

  const days = ['D1', 'D3', 'D5', 'D7', 'D9'];
  const dayAvgs = days.map(day => {
    let sum=0, cnt=0;
    d.forEach(r => { let v=parseFloat(String(r[day]).replace('%','')); if(!isNaN(v)){sum+=v; cnt++;} });
    return cnt ? (sum/cnt) : 0;
  });
  if(charts.ts) charts.ts.destroy();
  charts.ts = new Chart(document.getElementById('chartTimeSeries'), { type: 'line', data: { labels:days, datasets:[{label:'ìˆ˜ìµì¶”ì´', data:dayAvgs, borderColor:'#60a5fa', fill:true, backgroundColor:'rgba(96,165,250,0.1)'}] }, options:{plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'#1e293b'}}}} });
  
  Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#1e293b';
}

document.getElementById('btnRefresh').onclick = load;
window.onload = load;
</script>
</body>
</html>
